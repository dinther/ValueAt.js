<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Beam editor for show lasers.">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ValueAt.js</title>
        <link rel="stylesheet" href="index.css">
        <link rel="stylesheet" href="timelineManager.css">
        <link rel="stylesheet" href="wavedisplay.css">
	</head>
	<body>
        <div id="workarea"></div>
        <div id="timeline"></div>

        <script type="module">
            import * as VA_Utils from "./valueAtUtils.js";
            import {LookupAtTime} from "./valueat.js"
            import * as lookupAtExport from "./lookupAtToStepList.js";
            import * as Easings from "./easings.js";
            //import {drawValueAtOnSVG, createValueAtUILine} from "./valueui.js";
            import {TimelineManager} from "./timelineManager.js";
            import {ChannelGroup} from "./channelGroup.js";
            import {ValueChannel} from "./valueChannel.js";
            import {WaveDisplay} from "./wavedisplay.js";
            import {AudioObject} from "./audioObject.js";
            import * as Icons from "./appIcons.js";

            import {Circle} from "./circle.js"

            var bpm = 133; //132.97872340425533
            var timePerBeat = 60 / bpm;
            var waveDisplay;
            var start;
            var cursorStart;
            var samplesPerBeat;
            var offset = 0.143;
            var playStop = false;
            var loop = false;
            var audioBuffer;
            var source;
            var generators = [];

            var circle1 = new Circle(document.querySelector('#workarea'), '', 'circle',10, 50, 127, 200, 50, 50);
            generators.push(circle1);
            
            var va_radius1 = new LookupAtTime({object: circle1, property: 'radius', min: 0, max: 20, listType: 'Float32Array'});



            va_radius1.addValueKey({time: 0, value: 10});
            for (let i=1; i < 17; i++){
                va_radius1.addValueKey({time: i, value: 13});
                va_radius1.addValueKey({time: i+0.001, value: 10, easing: Easings.easeInSine});
            }
            va_radius1.init(0.1);

            var va_red1 = new LookupAtTime({object: circle1, property: 'r', min: 0, max: 255, listType: 'Uint8Array'});
            va_red1.addValueKey({time: 0, value: 0});
            va_red1.addValueKey({time: 2, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 4, value: 0, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 6, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 8, value: 0, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 10, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 12, value: 0, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 14, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 16, value: 0, easing: Easings.easeInOutCubic});   
            va_red1.init(0.1);
             
            var va_green1 = new LookupAtTime({object: circle1, property: 'g', min: 0, max: 255, listType: 'Uint8Array'});
            va_green1.addValueKey({time: 0, value: 255});
            va_green1.addValueKey({time: 2, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 4, value: 255, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 6, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 8, value: 255, easing: Easings.easeInOutCubic});            
            va_green1.addValueKey({time: 10, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 12, value: 255, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 14, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 16, value: 255, easing: Easings.easeInOutCubic});    
            va_green1.init(0.1);

            var va_blue1 = new LookupAtTime({object: circle1, property: 'b', min: 0, max: 255, listType: 'Uint8Array'});
            va_blue1.addValueKey({time: 0, value: 0});
            va_blue1.addValueKey({time: 4, value: 255, easing: Easings.easeInOutCubic});
            va_blue1.addValueKey({time: 8, value: 0, easing: Easings.easeInOutCubic});
            va_blue1.addValueKey({time: 12, value: 255, easing: Easings.easeInOutCubic});
            va_blue1.addValueKey({time: 16, value: 0, easing: Easings.easeInOutCubic});            
            va_blue1.init(0.1);            

            var va_pos_x1 = new LookupAtTime({object: circle1, property: 'x', min: 0, max: 100, listType: 'Float32Array'});
            let p1 = 16;
            let p2 = 2;
            let e = Easings.easeInExpo;
            va_pos_x1.addValueKey({time: 0, value: 0});
            va_pos_x1.addValueKey({time: 0.20, value: 15, easing: Easings.easeOutSine, p1: 2, p2: p2});
            va_pos_x1.addValueKey({time: 0.45, value: 12.5, easing: Easings.easeInSine, p1: 2, p2: p2});
            va_pos_x1.addValueKey({time: 0.70, value: 10, easing: Easings.easeOutSine, p1: 2, p2: p2});
            va_pos_x1.addValueKey({time: 1, value: 25, easing: Easings.easeInSine, p1: 2, p2: p2});
            va_pos_x1.addValueKey({time: 2, value: 50, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 3, value: 75, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 4, value: 100, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 5, value: 75, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 6, value: 50, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 7, value: 25, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 8, value: 0, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 8.45, value: 12.5, easing: Easings.stepped, p1: 2, p2: p2});
            va_pos_x1.addValueKey({time: 9, value: 25, easing: Easings.stepped, p1: 2, p2: p2});
            va_pos_x1.addValueKey({time: 10, value: 50, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 11, value: 75, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 12, value: 100, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 13, value: 75, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 14, value: 50, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 15, value: 25, easing: e, p1: p1, p2: p2});
            va_pos_x1.addValueKey({time: 16, value: 0, easing: e, p1: p1, p2: p2});            
            va_pos_x1.init(0.01);     

            var va_pos_y1 = new LookupAtTime({object: circle1, property: 'y', min: 0, max: 100, listType: 'Float32Array'});
            va_pos_y1.addValueKey({time: 0, value: 50});
            va_pos_y1.addValueKey({time: 16, value: 50});
            va_pos_y1.init(0.01);


            var timeLine = new TimelineManager(document.querySelector('#timeline'), 16, 2);
            timeLine.durationLabel.innerText = 'Length in beats';
            
            let bpmpair = VA_Utils.createEl('div', {className: 'labeled-input'}, timeLine.scaleInfoDiv);
            VA_Utils.createEl('label', {className: 'valueAt-info-label', for: 'bpmInput', innerText: 'BPM'}, bpmpair);
            var bpmInput = VA_Utils.createEl('input', {id: 'bpmInput', type: 'number', step: '0.1', value: (60 / timePerBeat).toFixed(1)}, bpmpair);

            bpmInput.addEventListener('input', (e)=>{
                let b = parseFloat(bpmInput.value);
                if (!isNaN(bpm)){
                    bpm = b;
                    timePerBeat = 60 / bpm;
                    timeLine.update();
                    setWaveDisplay(timeLine.viewStart, timeLine.viewRange);
                }
            });

            let resetBtn = VA_Utils.createEl('button', {className: 'icon-button'}, timeLine.footerDiv);
            resetBtn.innerHTML = Icons.getSVG('backToStart');
            resetBtn.addEventListener('click', (e)=>{
                audioObject.audioElm.currentTime = 0;
                timeLine.setTimeFast(0);
                setWaveDisplay(timeLine.viewStart, timeLine.viewRange)
            });

            let playBtn = VA_Utils.createEl('button', {className: 'icon-button'}, timeLine.footerDiv);
            playBtn.innerHTML = Icons.getSVG('play');
                playBtn.addEventListener('click', (e)=>{
                playStop = false;
                start = undefined;
                audioObject.audioElm.play();
                requestAnimationFrame(stepFrame);
            });

            let pauseBtn = VA_Utils.createEl('button', {className: 'icon-button'}, timeLine.footerDiv);
            pauseBtn.innerHTML = Icons.getSVG('pause');
            pauseBtn.addEventListener('click', (e)=>{
                audioObject.audioElm.pause();
                playStop = true;
            });

            let toEndBtn = VA_Utils.createEl('button', {className: 'icon-button'}, timeLine.footerDiv);
            toEndBtn.innerHTML = Icons.getSVG('forwardToEnd');
            toEndBtn.addEventListener('click', (e)=>{
                playStop = true;
                start = undefined;
                timeLine.setTime(timeLine.duration);
            });

            let loopBtn = VA_Utils.createEl('button', {className: 'icon-button'}, timeLine.footerDiv);
            loopBtn.innerHTML = Icons.getSVG('loop');
            loopBtn.addEventListener('click', (e)=>{
                loop = !loop;
                loopBtn.classList.toggle('selected');
            });            

            var audioObject = new AudioObject(null, null, 'song', 120);
            let audioLine = new ValueChannel(timeLine, timeLine.rootChannelGroup, {valueAt: audioObject.valueAt, name: 'music.mp3', strokeColor: '#f0f'});
            audioLine.labelDiv.style.flexDirection = 'column';
            audioLine.labelDiv.style.justifyContent = 'start';
            audioLine.labelDiv.style.gap = '4px';

            let offsetPair = VA_Utils.createEl('div', {className: 'labeled-input'}, audioLine.labelDiv);
            VA_Utils.createEl('label', {for: 'offsetInput', innerText: 'Offset (ms)'}, offsetPair);
            
            var offsetInput = VA_Utils.createEl('input', {id: 'offsetInput', type: 'number', min: 0, step: '1', value: 143}, offsetPair);
            offsetInput.addEventListener('input', (e)=>{
                if (!isNaN(parseInt(offsetInput.value))){
                    offset = parseInt(offsetInput.value) / 1000;
                    setWaveDisplay(timeLine.viewStart, timeLine.viewRange);
                }
            });
            
            audioObject.audioElm.addEventListener('play', (e)=>{
                playBtn.classList.add('active');
            });
            
            audioObject.audioElm.addEventListener('pause', (e)=>{
                playBtn.classList.remove('active');
            }); 

            /*
            audioObject.audioElm.addEventListener('seeked', (e)=>{ 
                let beat = audioObject.audioElm.currentTime / timePerBeat;
                let index = timeLine.viewStart + Math.floor(beat / timeLine.duration) * timeLine.duration;
                console.log('dfg');
            });
            */

            audioObject.loadAudioURL('./music.mp3').then((waveDisplay)=>{
                audioObject.audioElm.currentTime = 0;
                audioObject.setParent(audioLine.svgWrapperDiv, true);
                samplesPerBeat = audioObject.waveDisplay.options.sampleRate * timePerBeat;
                audioObject.waveDisplay.svg.style.position = 'absolute';
                audioObject.waveDisplay.svg.style.height = '100%';
                audioLine.svgWrapperDiv.parentElement.classList.add('valueAt-wave-line');
                audioLine.onRender = (viewStart, viewRange)=>{
                    setWaveDisplay(viewStart, viewRange);                  
                }
                timeLine.onTime = (time) =>{
                    setWaveDisplay(timeLine.viewStart, timeLine.viewRange);
                }
                setWaveDisplay(timeLine.viewStart, timeLine.viewRange);
            });

            function setWaveDisplay(startBeat, beatRange){
                let currentBeat = audioObject.audioElm.currentTime / timePerBeat;
                let startIndex = (offset * audioObject.waveDisplay.options.sampleRate) + (startBeat+ Math.floor(currentBeat / timeLine.duration) * timeLine.duration) * samplesPerBeat;
                audioObject.waveDisplay.setView(startIndex, startIndex + (beatRange * timePerBeat * audioObject.waveDisplay.options.sampleRate));
            }

            let circlegroup1 = new ChannelGroup(timeLine, timeLine.rootGroup, {name: 'Circle 1', expanded: true});
            let radiusChannel = new ValueChannel(timeLine, circlegroup1, {valueAt: va_radius1, name: 'Radius', strokeWidth: 1, strokeColor: '#f0f'});
            let colorGroup1 = new ChannelGroup(timeLine, circlegroup1, {name: 'Color', expanded: true});
            let redChannel = new ValueChannel(timeLine, colorGroup1, {valueAt: va_red1, name: 'Red', strokeWidth: 1, strokeColor: '#f00'});
            let greenChannel = new ValueChannel(timeLine, colorGroup1, {valueAt: va_green1, name: 'Green', strokeWidth: 1, strokeColor: '#0f0'});
            let blueChannel = new ValueChannel(timeLine, colorGroup1, {valueAt: va_blue1, name: 'Blue', strokeWidth: 1, strokeColor: '#00f'});
            let transformGroup1 = new ChannelGroup(timeLine, circlegroup1, {name: 'Transform', expanded: true});
            let positionGroup1 = new ChannelGroup(timeLine, transformGroup1, {name: 'Position', expanded: true});
            let xChannel1 = new ValueChannel(timeLine, positionGroup1, {valueAt: va_pos_x1, name: 'Pos X'});
            let yChannel1 = new ValueChannel(timeLine, positionGroup1, {valueAt: va_pos_y1, name: 'Pos Y'});

            timeLine.init();
            
            function stepFrame(timestamp) {
                if (start === undefined) {
                    start = timestamp;
                    cursorStart = timeLine.cursorTime; 
                }
                const elapsed = (timestamp - start) / 1000;
                if (loop){
                    timeLine.setTimeFast(((audioObject.audioElm.currentTime - offset) / timePerBeat) % timeLine.duration);
                } else {
                    timeLine.setTimeFast((audioObject.audioElm.currentTime - offset) / timePerBeat);
                }
                
                if (!playStop){
                    requestAnimationFrame(stepFrame); 
                }
            }

            // Set up audio context
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();

            window.computeStepList = lookupAtExport.computeStepList;
            window.typedArrayToFile = lookupAtExport.typedArrayToFile;
            window.Easings = Easings;
            window.timeLine = timeLine;
            window.va_red1 = va_red1;
            window.circle1 = circle1;
            window.va_pos_x1 = va_pos_x1;
            window.waveDisplay = waveDisplay;
            window.audioObject = audioObject;
            window.audioContext = audioContext;
        </script>
    </body>
</html>

