<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Beam editor for show lasers.">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ValueAt.js</title>
        <link rel="stylesheet" href="index.css">
        <link rel="stylesheet" href="valueAtTimeline.css">
        <link rel="stylesheet" href="wavedisplay.css">
	</head>
	<body>
        <div id="workarea"></div>
        <div id="timeline"></div>

        <script type="module">
            import * as VA_Utils from "./valueAtUtils.js";
            import {LookupAtTime} from "./valueat.js"
            import * as lookupAtExport from "./lookupAtToStepList.js";
            import * as Easings from "./easings.js";
            import {drawValueAtOnSVG, createValueAtUILine} from "./valueui.js";
            import {ValueAtTimeLine} from "./valueAtTimeline.js";
            import {WaveDisplay} from "./wavedisplay.js";
            import {AudioObject} from "./audioObject.js";

            import {Circle} from "./circle.js"

            var circle1 = new Circle(document.querySelector('#workarea'), 'circle1', 'circle',10, 50, 127, 200, 50, 50);
            var audioObject = new AudioObject(null, null, 'song', 120);

            var va_radius1 = new LookupAtTime({object: circle1, property: 'radius', min: 0, max: 40, listType: 'Float32Array'});
            let b = 0.4512; //0.46875;
            let x = 0;
            let s = 10;
            let l = 12;
            va_radius1.addValueKey({time: x, value: s}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.init(0.1);

            var va_red1 = new LookupAtTime({object: circle1, property: 'r', min: 0, max: 255, listType: 'Uint8Array'});
            va_red1.addValueKey({time: 0, value: 0});
            va_red1.addValueKey({time: 2 * b, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 4 * b, value: 0, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 6 * b, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 8 * b, value: 0, easing: Easings.easeInOutCubic});
            va_red1.init(0.1);
             
            var va_green1 = new LookupAtTime({object: circle1, property: 'g', min: 0, max: 255, listType: 'Uint8Array'});
            va_green1.addValueKey({time: 0, value: 255});
            va_green1.addValueKey({time: 2 * b, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 4 * b, value: 255, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 6 * b, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 8 * b, value: 255, easing: Easings.easeInOutCubic});            
            va_green1.init(0.1);

            var va_blue1 = new LookupAtTime({object: circle1, property: 'b', min: 0, max: 255, listType: 'Uint8Array'});
            va_blue1.addValueKey({time: 0, value: 0});
            va_blue1.addValueKey({time: 4 * b, value: 255, easing: Easings.easeInOutCubic});
            va_blue1.addValueKey({time: 8 * b, value: 0, easing: Easings.easeInOutCubic});
            va_blue1.init(0.1);            

            var va_pos_x1 = new LookupAtTime({object: circle1, property: 'x', min: 0, max: 100, listType: 'Float32Array'});
            x = 0;
            va_pos_x1.addValueKey({time: x, value: 0}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 25, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 50, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 75, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 100, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 75, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 50, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 25, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 0, easing: Easings.easeInExpo});
            va_pos_x1.init(0.01);     

            var va_pos_y1 = new LookupAtTime({object: circle1, property: 'y', min: 0, max: 100, listType: 'Float32Array'});
            va_pos_y1.addValueKey({time: 0, value: 50});
            va_pos_y1.addValueKey({time: 4, value: 50, easing: Easings.stepped, magnitude: 0.1});
            va_pos_y1.init(0.01);
         
            var timeLine = new ValueAtTimeLine(document.querySelector('#timeline'), 0, 8* b, 1);

            let resetBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'⏮'}, timeLine.footerDiv);
            resetBtn.addEventListener('click', (e)=>{
                audioObject.audioElm.currentTime = 0;
                timeLine.setTimeFast(timeLine.dataRangeStart);
            });

            let playBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'▶'}, timeLine.footerDiv);
            playBtn.addEventListener('click', (e)=>{
                playStop = false;
                start = undefined;
                audioObject.audioElm.play();
                //audio1.play();
                //source = audioContext.createBufferSource();
                //source.buffer = audioBuffer;
                //source.connect(audioContext.destination);
                //source.start();
                requestAnimationFrame(stepFrame);
            });

            let stopBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'⏹'}, timeLine.footerDiv);
            stopBtn.addEventListener('click', (e)=>{
                //source.stop();
                audioObject.audioElm.pause();
                //audio1.pause();
                playStop = true;
            });

            let toEndBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'⏭'}, timeLine.footerDiv);
            toEndBtn.addEventListener('click', (e)=>{
                playStop = true;
                start = undefined;
                timeLine.setTime(timeLine.dataRangeEnd);
            });

            let loopBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'⟳'}, timeLine.footerDiv);
            loopBtn.addEventListener('click', (e)=>{
                loop = !loop;
            });            

            let audioLine = timeLine.addValueAt(audioObject.valueAt, 'music.mp3', 1, '#f0f');
            audioObject.loadAudioURL('./music.mp3').then(()=>{
                audioObject.setParent(audioLine.svgWrapperDiv, true);
                audioObject.waveDisplay.svg.style.position = 'absolute';
                audioObject.waveDisplay.svg.style.height = '100%';
                let elm = audioLine.svgWrapperDiv.lastChild;
                audioLine.svgWrapperDiv.insertBefore(elm, audioLine.svgWrapperDiv.firtChild);
                audioLine.svgWrapperDiv.parentElement.classList.add('valueAt-wave-line');// height = 'calc(var(--line-row-height) * 2)';
                audioLine.onRender = (viewStart, viewRange)=>{
                    audioObject.waveDisplay.zoom = audioObject.audioElm.duration / timeLine.viewRange;
                    let index = (timeLine.viewStart + Math.floor(audioObject.audioElm.currentTime / timeLine.dataRangeEnd) * timeLine.dataRangeEnd) * audioObject.waveDisplay.options.sampleRate;
                    audioObject.waveDisplay.setStartIndex(index);                    
                }
                timeLine.onTime = (time) =>{
                    let index = (timeLine.viewStart + Math.floor(audioObject.audioElm.currentTime / timeLine.dataRangeEnd) * timeLine.dataRangeEnd) * audioObject.waveDisplay.options.sampleRate;
                    audioObject.waveDisplay.setStartIndex(index);
                }
                audioLine.update();
            });

            let circlegroup1 = timeLine.addValueAtGroup('Circle 1', true);
            circlegroup1.addValueAt(va_radius1, 'Radius', 1, '#f0f', true);
            let colorGroup1 = circlegroup1.addValueAtGroup('Color', true);
            colorGroup1.addValueAt(va_red1, 'Red', 1, '#f00');
            colorGroup1.addValueAt(va_green1, 'Green', 1, '#0f0');
            colorGroup1.addValueAt(va_blue1, 'Blue', 1, '#00f');

            let transformGroup1 = circlegroup1.addValueAtGroup('Transform', true);

            let positionGroup1 = transformGroup1.addValueAtGroup('Position', true);
            positionGroup1.addValueAt(va_pos_x1, 'Pos X', 1);
            positionGroup1.addValueAt(va_pos_y1, 'Pos Y', 1);

            timeLine.init();
            var waveDisplay;
            var start;
            var cursorStart;
            var playStop = false;
            var loop = true;
            var audioBuffer;
            var source;
            
            function stepFrame(timestamp) {
                if (start === undefined) {
                    start = timestamp;
                    cursorStart = timeLine.cursorTime; 
                }
                const elapsed = (timestamp - start) / 1000;
                if (loop){
                    timeLine.setTimeFast(audioObject.audioElm.currentTime % timeLine.dataRangeEnd);// cursorStart + elapsed);
                } else {
                    timeLine.setTimeFast(audioObject.audioElm.currentTime);
                }
                
                //let index = Math.floor(audioObject.audioElm.currentTime / timeLine.dataRangeEnd) * timeLine.dataRangeEnd * waveDisplay.options.sampleRate;

                //waveDisplay.setStartIndex(index);
                
                if (!playStop){
                    //if (elapsed <= timeLine.dataRangeEnd){
                    //    requestAnimationFrame(stepFrame);
                    //} else if (loop){
                    //    start = undefined;
                    //    timeLine.setTimeAccurate(0);
                        requestAnimationFrame(stepFrame); 
                    //} else {
                    //    playStop = true;
                    //}
                }
            }

            // Set up audio context
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();


            //var audio1 = new Audio();


            // Get the audio data
            /*
            fetch('./music.mp3')
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => {
                //audio1.src = URL.createObjectURL(new Blob([arrayBuffer]));  //  Does this use the same data?
                return audioContext.decodeAudioData(arrayBuffer)
            }).then(audioBuf => {
                audioBuffer = audioBuf;
                waveDisplay = new WaveDisplay({
                    data: audioBuffer.getChannelData(0),
                    parent: timeLine.scaleDiv,
                    samplesPerPoint: 60,
                    sampleRate: audioBuffer.sampleRate,
                    zoomRate: 0.1,
                    decelerationTime: 4,
                    scale: 1,
                    zoom: 2,
                });
                let duration = waveDisplay.options.parent.offsetWidth * waveDisplay.samplesPerPixel / waveDisplay.options.sampleRate * waveDisplay.zoom;
                waveDisplay.zoom = duration / timeLine.viewRange;
                window.waveDisplay = waveDisplay;
            });
            */

            window.computeStepList = lookupAtExport.computeStepList;
            window.typedArrayToFile = lookupAtExport.typedArrayToFile;
            window.Easings = Easings;
            window.timeLine = timeLine;
            window.va_radius = va_radius1;
            window.circle1 = circle1;
            window.va_pos_y1 = va_pos_y1;
            window.waveDisplay = waveDisplay;
            window.audioObject = audioObject;
            window.audioContext = audioContext;
        </script>
    </body>
</html>

