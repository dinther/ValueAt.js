<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Beam editor for show lasers.">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ValueAt.js</title>
        <link rel="stylesheet" href="index.css">
        <link rel="stylesheet" href="valueAtTimeline.css">
        <link rel="stylesheet" href="wavedisplay.css">
	</head>
	<body>
        <div id="workarea"></div>
        <div id="timeline"></div>

        <script type="module">
            import * as VA_Utils from "./valueAtUtils.js";
            import {LookupAtTime} from "./valueat.js"
            import * as lookupAtExport from "./lookupAtToStepList.js";
            import * as Easings from "./easings.js";
            import {drawValueAtOnSVG, createValueAtUILine} from "./valueui.js";
            import {ValueAtTimeLine} from "./valueAtTimeline.js";
            import {WaveDisplay} from "./wavedisplay.js";

            import {Circle} from "./circle.js"

            var circle1 = new Circle(document.querySelector('#workarea'), 'circle1', 'circle',10, 50, 127, 200, 50, 50);
            //var circle2 = new Circle(document.querySelector('#workarea'), 'circle2', 'circle', 10, 50, 127, 200, 50, 50);

            var va_radius1 = new LookupAtTime({object: circle1, property: 'radius', min: 0, max: 40, listType: 'Float32Array'});
            var magnitude = 1.70158;
            va_radius1.addValueKey({time: 0, value: 10});
            va_radius1.addValueKey({time: 1, value: 0, easing: Easings.easeInBack, magnitude: magnitude});
            va_radius1.addValueKey({time: 2, value: 5, easing: Easings.easeInBack, magnitude: magnitude});
            va_radius1.addValueKey({time: 45, value: 17, easing: Easings.easeInOutBack, magnitude: magnitude});
            va_radius1.addValueKey({time: 55, value: 17, easing: Easings.easeInOutBack, magnitude: magnitude});
            va_radius1.addValueKey({time: 75, value: 18, easing: Easings.easeInOutBack, magnitude: magnitude});
            va_radius1.addValueKey({time: 100, value: 1, easing: Easings.easeInOutBack, magnitude: magnitude});
            va_radius1.init(0.1);

            var va_red1 = new LookupAtTime({object: circle1, property: 'r', min: 0, max: 255, listType: 'Int8Array'});
            let step = 1;
            let r = 0.6;
            let x = 0;
            let v = 100;
            va_red1.addValueKey({time: x, value: 0, easing: Easings.easeInOutBack, magnitude: magnitude}); x += step;
            for (let i=0; i< 7; i++){
                va_red1.addValueKey({time: x, value: v, easing: Easings.easeOutSine}); x += step; step *= r;
                va_red1.addValueKey({time: x, value: 0, easing: Easings.easeInSine}); x += step; v *= r;   
            }
            va_red1.addValueKey({time: 16.5, value: 140, easing: Easings.easeInOutCirc});
            va_red1.addValueKey({time: 40, value: 250, easing: Easings.easeInOutCirc});
            va_red1.addValueKey({time: 86, value: 0, easing: Easings.easeInOutCirc});
            va_red1.addValueKey({time: 90, value: 127, easing: Easings.easeInOutCirc});
            va_red1.init(0.1);
             
            var va_green1 = new LookupAtTime({object: circle1, property: 'g', min: 0, max: 255, listType: 'Uint8Array'});
            va_green1.addValueKey({time: 0, value: 255});
            va_green1.addValueKey({time: 40, value: 155, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 75, value: 40, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 100, value: 255, easing: Easings.easeInOutCubic});
            va_green1.init(0.1);

            var va_blue1 = new LookupAtTime({object: circle1, property: 'b', min: 0, max: 255, listType: 'Uint8Array'});
            va_blue1.addValueKey({time: 0, value: 0});
            va_blue1.addValueKey({time: 50, value: 255, easing: Easings.easeInOutCubic});
            va_blue1.addValueKey({time: 95, value: 60, easing: Easings.stepped});
            va_blue1.addValueKey({time: 100, value: 0, easing: Easings.easeInOutCubic});
            va_blue1.init(0.1);            

            var va_pos_x1 = new LookupAtTime({object: circle1, property: 'x', min: 0, max: 100, listType: 'Float32Array'});
            va_pos_x1.addValueKey({time: 10, value: 40});
            va_pos_x1.addValueKey({time: 30, value: 90, easing: Easings.easeInOutCubic});
            va_pos_x1.addValueKey({time: 37, value: 30, easing: Easings.easeInOutCubic});
            va_pos_x1.addValueKey({time: 60, value: 60, easing: Easings.easeInOutCubic});
            va_pos_x1.addValueKey({time: 75, value: 10, easing: Easings.easeInOutCubic});
            va_pos_x1.addValueKey({time: 100, value: 60, easing: Easings.easeIn});
            va_pos_x1.init(0.01);     

            var va_pos_y1 = new LookupAtTime({object: circle1, property: 'y', min: 0, max: 100, listType: 'Float32Array'});

            //  construct our own bounce animation
            step = 1;
            r = 0.8;
            x = 0;
            v = 100;
            va_pos_y1.addValueKey({time: x, value: 0}); x += step;
            for (let i=0; i< 14; i++){
                va_pos_y1.addValueKey({time: x, value: v, easing: Easings.easeOutSine}); x += step; step *= r;
                va_pos_y1.addValueKey({time: x, value: 0, easing: Easings.easeInSine}); x += step; v *= r;   
            }
            va_pos_y1.addValueKey({time: x, value: 10, easing: Easings.easeInOutCirc});
            va_pos_y1.addValueKey({time: 13.5, value: 10, easing: Easings.stepped, magnitude: 0.1});
            va_pos_y1.addValueKey({time: 14.4, value: 2, easing: Easings.stepped, magnitude: 0.3});
            va_pos_y1.addValueKey({time: 15, value: 80, easing: Easings.stepped, magnitude: 0.1});
            va_pos_y1.addValueKey({time: 25.5, value: 2, easing: Easings.stepped, magnitude: 0.05});
            va_pos_y1.addValueKey({time: 40, value: 4, easing: Easings.easeInOutCirc});
            va_pos_y1.addValueKey({time: 43, value: 79, easing: Easings.easeInOutCirc});
            va_pos_y1.addValueKey({time: 60, value: 70, easing: Easings.easeInOutCirc});
            va_pos_y1.addValueKey({time: 67, value: 25, easing: Easings.easeInOutCirc});
            va_pos_y1.addValueKey({time: 86, value: 74, easing: Easings.easeInOutCirc});
            va_pos_y1.addValueKey({time: 90, value: 0, easing: Easings.easeInOutCirc});
            va_pos_y1.init(0.01);

            /*
            var va_radius2 = new LookupAtTime(circle2, 'radius');
            va_radius2.addValueKey(0,3);
            step = 0.25
            let repeat = 40;
            x = step;
            for (let i=0; i<repeat; i++){
                va_radius2.addValueKey(x, 20, Easings.easeOutCirc); x+= step;
                va_radius2.addValueKey(x, 5, Easings.easeInCirc); x+= step;
            }
            va_radius2.addValueKey(30, 13, Easings.easeOutBounce,5);
            va_radius2.addValueKey(50, 30, Easings.easeOutBounce,5);
            va_radius2.addValueKey(60, 7, Easings.easeOutBounce,5);
            va_radius2.addValueKey(80, 2, Easings.easeOutBounce,5);            
            va_radius2.init(0.01);

            var va_red2 = new LookupAtTime(circle2, 'r');
            var va_green2 = new LookupAtTime(circle2, 'g');
            var va_blue2 = new LookupAtTime(circle2, 'b');
            //  Random generated value keys. They are automatically sorted by time on init.
            for (let i = 0; i < 17; i++){
                va_red2.addValueKey(Math.random()  *100, Math.random() * 255, Easings.easeOutBounce);
                va_green2.addValueKey(Math.random() * 100, Math.random() * 255, Easings.easeOutBounce);
                va_blue2.addValueKey(Math.random() * 100, Math.random() * 255, Easings.easeOutBounce);
            }
            va_red2.init(0.1);
            va_green2.init(0.1);
            va_blue2.init(0.1);
            

            var va_pos_x2 = new LookupAtTime(circle2, 'x');
            va_pos_x2.addValueKey(0, 31, Easings.easeOutCubic, 0.5);
            for (let i = 0; i < 17; i++){
                va_pos_x2.addValueKey(5 + Math.random() * 30, Math.random() * 100, Easings.easeOutBounce);
            }
            va_pos_x2.addValueKey(40, 11, Easings.easeOutCubic, 0.5);
            va_pos_x2.addValueKey(50, 20, Easings.easeInOutCubic);
            va_pos_x2.addValueKey(65, 1, Easings.easeInOutCubic);
            va_pos_x2.addValueKey(75, 15, Easings.easeInOutCubic);
            va_pos_x2.addValueKey(100, 5, Easings.easeInCubic);
            va_pos_x2.init(0.01);

            var va_pos_y2 = new LookupAtTime(circle2, 'y');
            //  Random generated value keys. They are automatically sorted by time on init.
            for (let i = 0; i < 37; i++){
                va_pos_y2.addValueKey(Math.random() * 100, Math.random() * 100, Easings.easeOutBounce);
            }
            va_pos_y2.init(0.01);   
            */  
         
            var timeLine = new ValueAtTimeLine(document.querySelector('#timeline'), 0, 100, 1);

            var waveDisplay;

            let resetBtn = VA_Utils.createEl('button', {className: 'icon-button ', innerText:'⏮'}, timeLine.footerDiv);
            resetBtn.addEventListener('click', (e)=>{
                playStop = true;
                start = undefined;
                timeLine.setTimeFast(timeLine.dataRangeStart);
            });

            let playBtn = VA_Utils.createEl('button', {className: 'icon-button ', innerText:'▶'}, timeLine.footerDiv);
            playBtn.addEventListener('click', (e)=>{
                playStop = false;
                start = undefined;
                requestAnimationFrame(stepFrame);
            });

            let stopBtn = VA_Utils.createEl('button', {className: 'icon-button ', innerText:'⏹'}, timeLine.footerDiv);
            stopBtn.addEventListener('click', (e)=>{
                //timeLine.setTime(0);
                playStop = true;
            });

            let toEndBtn = VA_Utils.createEl('button', {className: 'icon-button ', innerText:'⏭'}, timeLine.footerDiv);
            toEndBtn.addEventListener('click', (e)=>{
                playStop = true;
                start = undefined;
                timeLine.setTime(timeLine.dataRangeEnd);
            });

            let circlegroup1 = timeLine.addNewValueAtGroup('Circle 1', true);
            circlegroup1.addValueAt(va_radius1, 'Radius', 1, '#f0f', true);
            let colorGroup1 = circlegroup1.addNewValueAtGroup('Color', true);
            colorGroup1.addValueAt(va_red1, 'Red',1, '#f00');
            colorGroup1.addValueAt(va_green1, 'Green', 1, '#0f0');
            colorGroup1.addValueAt(va_blue1, 'Blue', 1, '#00f');

            let transformGroup1 = circlegroup1.addNewValueAtGroup('Transform', true);

            let positionGroup1 = transformGroup1.addNewValueAtGroup('Position', true);
            positionGroup1.addValueAt(va_pos_x1, 'Pos X', 1);
            positionGroup1.addValueAt(va_pos_y1, 'Pos y', 1);

            /*
            let circlegroup2 = timeLine.addNewValueAtGroup('Circle 2', true);
            circlegroup2.addValueAt(va_radius2, 'Radius', 1, '#f0f', true);
            let colorGroup2 = circlegroup2.addNewValueAtGroup('Color', true);
            colorGroup2.addValueAt(va_red2, 'Red', 1, '#f00');
            colorGroup2.addValueAt(va_green2, 'Green', 1, '#0f0');
            colorGroup2.addValueAt(va_blue2, 'Blue', 1, '#00f');

            let transformGroup2 = circlegroup2.addNewValueAtGroup('Transform', true);

            let positionGroup2 = transformGroup2.addNewValueAtGroup('Position', true);
            positionGroup2.addValueAt(va_pos_x2, 'Pos X', 1);
            positionGroup2.addValueAt(va_pos_y2, 'Pos y', 1);
            */
            timeLine.init();

            window.computeStepList = lookupAtExport.computeStepList;
            window.typedArrayToFile = lookupAtExport.typedArrayToFile;
            window.Easings = Easings;
            window.valueAtTimeline = timeLine;
            window.va_radius = va_radius1;
            window.circle1 = circle1;
            //window.circle2 = circle2;
            window.va_pos_y1 = va_pos_y1;

            let start;
            let cursorStart;
            let playStop = false;
            function stepFrame(timestamp) {
                if (start === undefined) {
                    start = timestamp;
                    cursorStart = timeLine.cursorTime; 
                }
                const elapsed = (timestamp - start) / 1000;
                timeLine.setTimeAccurate(cursorStart + elapsed);
                if (!playStop && elapsed <= timeLine.dataRangeEnd){
                    requestAnimationFrame(stepFrame);
                }
            }

            // Set up audio context
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();

            var audioBuffer;

            // Get the audio data
            fetch('./music.mp3')
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(audioBuf => {
                audioBuffer = audioBuf;
                //let myNumberArray = arrayBuffer.getChannelData(0); //  We only want one channel

                //console.log(myNumberArray);

                //timeLine.setDataRange(0, Math.floor(audioBuffer.duration * 1000));

                waveDisplay = new WaveDisplay({
                    data: audioBuffer.getChannelData(0),
                    parent: timeLine.scaleDiv,
                    samplesPerPoint: 60,
                    sampleRate: audioBuffer.sampleRate,
                    zoomRate: 0.1,
                    decelerationTime: 4,
                    scale: 1,
                    zoom: 2,
                });

                window.waveDisplay = waveDisplay;
            });
        </script>
    </body>
</html>

