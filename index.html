<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Beam editor for show lasers.">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ValueAt.js</title>
        <link rel="stylesheet" href="index.css">
        <link rel="stylesheet" href="valueAtTimeline.css">
        <link rel="stylesheet" href="wavedisplay.css">
	</head>
	<body>
        <div id="workarea"></div>
        <div id="timeline"></div>

        <script type="module">
            import * as VA_Utils from "./valueAtUtils.js";
            import {LookupAtTime} from "./valueat.js"
            import * as lookupAtExport from "./lookupAtToStepList.js";
            import * as Easings from "./easings.js";
            import {drawValueAtOnSVG, createValueAtUILine} from "./valueui.js";
            import {ValueAtTimeLine} from "./valueAtTimeline.js";
            import {WaveDisplay} from "./wavedisplay.js";
            import {AudioObject} from "./audioObject.js";

            import {Circle} from "./circle.js"

            var circle1 = new Circle(document.querySelector('#workarea'), '', 'circle',10, 50, 127, 200, 50, 50);
            var audioObject = new AudioObject(null, null, 'song', 120);

            var va_radius1 = new LookupAtTime({object: circle1, property: 'radius', min: 0, max: 20, listType: 'Float32Array'});
            let b = 0.4512; //0.46875;
            let x = 0;
            let s = 10;
            let l = 12;
            va_radius1.addValueKey({time: x, value: s}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.addValueKey({time: x, value: s, easing: Easings.linear}); x+= b;
            va_radius1.addValueKey({time: x, value: l, easing: Easings.easeInSine});
            va_radius1.init(0.1);

            var va_red1 = new LookupAtTime({object: circle1, property: 'r', min: 0, max: 255, listType: 'Uint8Array'});
            va_red1.addValueKey({time: 0, value: 0});
            va_red1.addValueKey({time: 2 * b, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 4 * b, value: 0, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 6 * b, value: 255, easing: Easings.easeInOutCubic});
            va_red1.addValueKey({time: 8 * b, value: 0, easing: Easings.easeInOutCubic});
            va_red1.init(0.1);
             
            var va_green1 = new LookupAtTime({object: circle1, property: 'g', min: 0, max: 255, listType: 'Uint8Array'});
            va_green1.addValueKey({time: 0, value: 255});
            va_green1.addValueKey({time: 2 * b, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 4 * b, value: 255, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 6 * b, value: 0, easing: Easings.easeInOutCubic});
            va_green1.addValueKey({time: 8 * b, value: 255, easing: Easings.easeInOutCubic});            
            va_green1.init(0.1);

            var va_blue1 = new LookupAtTime({object: circle1, property: 'b', min: 0, max: 255, listType: 'Uint8Array'});
            va_blue1.addValueKey({time: 0, value: 0});
            va_blue1.addValueKey({time: 4 * b, value: 255, easing: Easings.easeInOutCubic});
            va_blue1.addValueKey({time: 8 * b, value: 0, easing: Easings.easeInOutCubic});
            va_blue1.init(0.1);            

            var va_pos_x1 = new LookupAtTime({object: circle1, property: 'x', min: 0, max: 100, listType: 'Float32Array'});
            x = 0;
            va_pos_x1.addValueKey({time: x, value: 0}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 25, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 50, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 75, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 100, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 75, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 50, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 25, easing: Easings.easeInExpo}); x+= b;
            va_pos_x1.addValueKey({time: x, value: 0, easing: Easings.easeInExpo});
            va_pos_x1.init(0.01);     

            var va_pos_y1 = new LookupAtTime({object: circle1, property: 'y', min: 0, max: 100, listType: 'Float32Array'});
            va_pos_y1.addValueKey({time: 0, value: 50});
            va_pos_y1.addValueKey({time: 8 * b, value: 50});
            va_pos_y1.init(0.01);
         
            var timeLine = new ValueAtTimeLine(document.querySelector('#timeline'), 0, 8* b, 1);

            let resetBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'⏮'}, timeLine.footerDiv);
            resetBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M860,-240 500,-480 860,-720Zm-400,0 -280,-187.94165V-240h-80v-480h80v179.96759L460,-720Zm-80,-150v-180l-136,90zm400,0v-180l-136,90z"/></svg>';
            resetBtn.addEventListener('click', (e)=>{
                audioObject.audioElm.currentTime = 0;
                timeLine.setTimeFast(timeLine.dataRangeStart);
            });

            let playBtn = VA_Utils.createEl('button', {className: 'icon-button'}, timeLine.footerDiv);
            playBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z"/></svg>';
            playBtn.addEventListener('click', (e)=>{
                playStop = false;
                start = undefined;
                audioObject.audioElm.play();
                requestAnimationFrame(stepFrame);
            });

            let stopBtn = VA_Utils.createEl('button', {className: 'icon-button'}, timeLine.footerDiv);
            stopBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M520-200v-560h240v560H520Zm-320 0v-560h240v560H200Zm400-80h80v-400h-80v400Zm-320 0h80v-400h-80v400Zm0-400v400-400Zm320 0v400-400Z"/></svg>';
            stopBtn.addEventListener('click', (e)=>{
                audioObject.audioElm.pause();
                playStop = true;
            });

            let toEndBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'⏭'}, timeLine.footerDiv);
            toEndBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M100-240 460-480 100-720Zm400 0 280-187.9417V-240h80v-480h-80v179.9676L500-720Zm80-150v-180l136 90zm-400 0v-180l136 90z"/></svg>';
            toEndBtn.addEventListener('click', (e)=>{
                playStop = true;
                start = undefined;
                timeLine.setTime(timeLine.dataRangeEnd);
            });

            let loopBtn = VA_Utils.createEl('button', {className: 'icon-button', innerText:'⟳'}, timeLine.footerDiv);
            loopBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M280-80 120-240l160-160 56 58-62 62h406v-160h80v240H274l62 62-56 58Zm-80-440v-240h486l-62-62 56-58 160 160-160 160-56-58 62-62H280v160h-80Z"/></svg>';
            loopBtn.addEventListener('click', (e)=>{
                loop = !loop;
                loopBtn.classList.toggle('selected');
            });            

            let audioLine = timeLine.addValueAt(audioObject.valueAt, 'music.mp3', 1, '#f0f');
            audioObject.audioElm.addEventListener('play', (e)=>{
                playBtn.classList.add('active');
            });
            audioObject.audioElm.addEventListener('pause', (e)=>{
                playBtn.classList.remove('active');
            });            
            audioObject.loadAudioURL('./music.mp3').then(()=>{
                audioObject.setParent(audioLine.lineDiv, true);
                audioObject.waveDisplay.svg.style.position = 'absolute';
                audioObject.waveDisplay.svg.style.height = '100%';
                audioLine.svgWrapperDiv.parentElement.classList.add('valueAt-wave-line');
                audioLine.onRender = (viewStart, viewRange)=>{
                    audioObject.waveDisplay.zoom = audioObject.audioElm.duration / timeLine.viewRange;
                    let index = (timeLine.viewStart + Math.floor(audioObject.audioElm.currentTime / timeLine.dataRangeEnd) * timeLine.dataRangeEnd) * audioObject.waveDisplay.options.sampleRate;
                    audioObject.waveDisplay.setStartIndex(index);                    
                }
                timeLine.onTime = (time) =>{
                    let index = (timeLine.viewStart + Math.floor(audioObject.audioElm.currentTime / timeLine.dataRangeEnd) * timeLine.dataRangeEnd) * audioObject.waveDisplay.options.sampleRate;
                    audioObject.waveDisplay.setStartIndex(index);
                }
                audioLine.update();
            });

            let circlegroup1 = timeLine.addValueAtGroup('Circle 1', true);
            circlegroup1.addValueAt(va_radius1, 'Radius', 1, '#f0f', true);
            let colorGroup1 = circlegroup1.addValueAtGroup('Color', true);
            colorGroup1.addValueAt(va_red1, 'Red', 1, '#f00');
            colorGroup1.addValueAt(va_green1, 'Green', 1, '#0f0');
            colorGroup1.addValueAt(va_blue1, 'Blue', 1, '#00f');

            let transformGroup1 = circlegroup1.addValueAtGroup('Transform', true);

            let positionGroup1 = transformGroup1.addValueAtGroup('Position', true);
            positionGroup1.addValueAt(va_pos_x1, 'Pos X', 1);
            positionGroup1.addValueAt(va_pos_y1, 'Pos Y', 1);

            timeLine.init();
            var waveDisplay;
            var start;
            var cursorStart;
            var playStop = false;
            var loop = false;
            var audioBuffer;
            var source;
            
            function stepFrame(timestamp) {
                if (start === undefined) {
                    start = timestamp;
                    cursorStart = timeLine.cursorTime; 
                }
                const elapsed = (timestamp - start) / 1000;
                if (loop){
                    timeLine.setTimeFast(audioObject.audioElm.currentTime % timeLine.dataRangeEnd);// cursorStart + elapsed);
                } else {
                    timeLine.setTimeFast(audioObject.audioElm.currentTime);
                }
                
                if (!playStop){
                    requestAnimationFrame(stepFrame); 
                }
            }

            // Set up audio context
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();

            window.computeStepList = lookupAtExport.computeStepList;
            window.typedArrayToFile = lookupAtExport.typedArrayToFile;
            window.Easings = Easings;
            window.timeLine = timeLine;
            window.va_radius = va_radius1;
            window.circle1 = circle1;
            window.va_pos_y1 = va_pos_y1;
            window.waveDisplay = waveDisplay;
            window.audioObject = audioObject;
            window.audioContext = audioContext;
        </script>
    </body>
</html>

